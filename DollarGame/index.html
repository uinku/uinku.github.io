<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/processing.js/1.6.6/processing.min.js"></script>
    <script type="text/javascript"> window.addEventListener('load', function() {
        var scripts=document.body.getElementsByTagName('script');
        var canvases=document.body.getElementsByTagName('canvas');
        new Processing(canvases[0], scripts[0].text);
      }, false);
    </script>
  </head>
  <body>
    <h1>Hello World</h1>
    <canvas id="myCanvas" width="400px" height="400px"></canvas>
    <script>
var game;

var printProperties = function(obj) {
    for (var key in obj) {
        if (obj.hasOwnProperty(key)) {
            println(key + " -> " + obj[key]);
        }
    }
};

/** Node **/

var Node = function(id, value, x, y) {
    this.id = id;
    this.value = value;
    this.x = x;
    this.y = y;
};

Node.prototype.toString = function() {
    return "Node [" + [this.id, this.value, this.x, this.y].join(", ") + "]";
};

Node.prototype.draw = function(d) {
    fill(255);
    ellipse(this.x, this.y, d, d);
    fill(0);
    text(this.value, this.x, this.y);
};

/** Graph **/

var Graph = function() {
    this.nodes = [];
    this.edges = [];
    this.edgeCount = 0;
};

Graph.prototype.createNode = function(value, x, y) {
    var node = new Node(this.edgeCount++, value, x, y);
    for (var i = 0; i < this.edges.length; i++) {
        this.edges[i].push(false);
    }
    var edgeConnections = [];
    for (var i = 0; i < this.nodes.length; i++) {
        edgeConnections.push(false);
    }
    edgeConnections.push(true);
    this.edges.push(edgeConnections);
    this.nodes.push(node);
};

Graph.prototype.isValidIndex = function(i) {
    return i >= 0 && i < this.nodes.length;
};

Graph.prototype.connect = function(i, j) {
    if (!this.isValidIndex(i) || !this.isValidIndex(j)) {
        return;
    }
    this.edges[i][j] = true;
    this.edges[j][i] = true;
};

Graph.prototype.getConnectedEdges = function(index) {
    var edges = [];
    for (var i = 0; i < this.edges[index].length; i++) {
        if (this.edges[index][i] === true) {
            edges.push(i);
        }
    }
    return edges;
};

Graph.prototype.getGenus = function() {
    return this.edgeCount - this.nodes.length + 1;
};

Graph.prototype.getSum = function() {
    return this.nodes.reduce( function(sum, node) { return sum + node.value; }, 0 );
};

Graph.prototype.print = function() {
    println(this.nodes);
    for (var i = 0; i < this.edges.length; i++) {
        println(this.edges[i]);
    }
};

Graph.prototype.drawEdges = function(sw) {
    strokeWeight(sw);
    stroke(0);
    for (var i = 0; i < this.nodes.length; i++) {
        for (var j = i + 1; j < this.nodes.length; j++) {
            if (this.edges[i][j] === true) {
                line(this.nodes[i].x, this.nodes[i].y, this.nodes[j].x, this.nodes[j].y);
            }
        }
    }
};

Graph.prototype.drawNodes = function(nodeRadius) {
    strokeWeight(2);
    stroke(0);
    fill(255);
    var d = nodeRadius * 2;
    textSize(nodeRadius);
    textAlign(CENTER, CENTER);
    for (var i = 0; i < this.nodes.length; i++) {
        this.nodes[i].draw(d);
    }
};

Graph.prototype.draw = function(edgeSW, nodeRadius, nodeSW) {
    this.drawEdges(edgeSW);
    this.drawNodes(nodeRadius, nodeSW);
};

/** Game **/

var Game = function(nodeRadius) {
    this.nodeRadius = nodeRadius;
    this.mouseOverNodeRadius = nodeRadius + 5;
    this.mouseOverNode = null;
    this.moveCount = 0;
    
    this.graph = new Graph();
    this.graph.createNode(-1, width * 0.2, height * 0.4);
    this.graph.createNode(-2, width * 0.8, height * 0.4);
    this.graph.createNode(1, width * 0.5, height * 0.15);
    this.graph.createNode(3, width * 0.5, height * 0.75);
    this.graph.createNode(2, width * 0.25, height * 0.75);
    this.graph.connect(0, 1);
    this.graph.connect(1, 2);
    this.graph.connect(2, 3);
    this.graph.connect(1, 3);
    this.graph.connect(3, 4);
};

Game.prototype.draw = function() {
    background(245);
    this.graph.draw(4, this.nodeRadius, 2);
    if (this.mouseOverNode !== null) {
        strokeWeight(3);
        stroke(255, 81, 0);
        noFill();
        ellipse(this.mouseOverNode.x, this.mouseOverNode.y, this.mouseOverNodeRadius * 2, this.mouseOverNodeRadius * 2);
    }
};

Game.prototype.getNodeAt = function(x, y) {
    for (var i = 0; i < this.graph.nodes.length; i++) {
        var node = this.graph.nodes[i];
        if (dist(node.x, node.y, x, y) <= this.nodeRadius) {
            return node;
        }
    }
    return null;
};

Game.prototype.splitWealth = function(node, isOutward) {
    var connectedEdges = this.graph.getConnectedEdges(node.id);
    var amount = isOutward ? 1 : -1;
    for (var i = 0; i < connectedEdges.length; i++) {
        var other = this.graph.nodes[connectedEdges[i]];
        if (node === other) {
            continue;
        }
        node.value -= amount;
        other.value += amount;
    }
};

Game.prototype.isSolvable = function() {
    return this.graph.getSum() >= this.graph.getGenus();
};

Game.prototype.checkWinCondition = function() {
    for (var i = 0; i < this.graph.nodes.length; i++) {
        //println(this.graph.nodes[i].value);
        if (this.graph.nodes[i].value < 0) {
            return false;
        }
    }
    return true;
};

Game.prototype.handleMove = function(x, y) {
    var node = this.getNodeAt(mouseX, mouseY);
    if (node === this.mouseOverNode) {
        return;
    }
    this.mouseOverNode = node;
    this.draw();
};

Game.prototype.handleClick = function(x, y, isPositive) {
    var node = this.getNodeAt(mouseX, mouseY);
    if (node === null) {
        return;
    }
    this.moveCount++;
    this.splitWealth(node, isPositive);
    if (this.checkWinCondition() === true) {
        _clearLogs();
        println("You won in " + this.moveCount + " move" + (this.moveCount === 1 ? "" : "s") + ".");
        (function(){return this;}).call(null)[["document"]].body.childNodes[0].style.height = "22px";
    }
    this.draw();
};

/** Input **/

var mouseMoved = function() {
    game.handleMove(mouseX, mouseY);
};

var mouseClicked = function() {
    game.handleClick(mouseX, mouseY, mouseButton === LEFT && !(keyIsPressed && keyCode === 16));
};

var keyPressed = function() {
    //println(keyCode);
    
    if (keyCode === 82) {
        Program.restart();
    }
};

/** Init **/

game = new Game(26);
/*game.graph.print();
println("genus: " + game.graph.getGenus());
println("sum: " + game.graph.getSum());
println("solvable: " + game.isSolvable());*/
game.draw();
    </script>
  </body>
</html>
